---
title: "data"
author: "Jiho Kwak, 2020-17530"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(showtext)

# 한글 폰트 추가 (구글 Noto Sans KR)
font_add_google("Noto Sans KR", "noto")
showtext_auto()
knitr::opts_chunk$set(echo = TRUE)
```
## library load
```{r}
library(dplyr)
library(stringr)
library(sf)
library(readr)
```

## geodata
```{r}
# 2. 파일 경로 설정
file_path <- "data/bnd_dong_00_2024_2Q/bnd_dong_00_2024_2Q.shp"

# 3. 파일 읽기
# 한국 Shapefile은 보통 'EUC-KR' (또는 'CP949') 인코딩을 사용합니다.
# 한글이 깨지는 것을 방지하기 위해 options 설정을 추가합니다.
# gdf <- st_read(file_path, options = "ENCODING=EUC-KR") 

# 만약 위 코드로 한글이 깨진다면 아래 줄의 주석을 풀고 실행해 보세요.
gdf <- st_read(file_path) # 기본 설정 (UTF-8일 경우)

# 4. 데이터 개체 확인 (상위 6개 행)
print("### 상위 데이터 확인 ###")
head(gdf)

# 5. 데이터 구조 및 좌표계(CRS) 확인
print("### 데이터 구조 및 좌표계 확인 ###")
# 행/열 개수, 컬럼 타입, Bounding Box, CRS(EPSG 코드 등) 정보를 보여줍니다.
print(gdf) 
# 좌표계만 따로 보고 싶을 때: st_crs(gdf)

# 6. 간단한 시각화 (형상 확인)
# 데이터가 너무 크면 그리는 데 시간이 걸릴 수 있으므로 geometry만 그립니다.
# plot(st_geometry(gdf), main = "2024 2Q Dong Boundary")
```
```{r}
# 2. 데이터 필터링
# [1단계] 포함할 지역 (기존 로직)
include_pattern <- "^37|^33540|^22520"

# [2단계] 제거할 지역 (요청하신 37540, 37530, 37630으로 시작하는 코드)
exclude_pattern <- "^37540|^37530|^37630"

gdf_filtered <- gdf %>% 
  # 포함 로직
  dplyr::filter(str_detect(ADM_CD, include_pattern)) %>%
  # 제거 로직 (! 기호를 사용하여 제외)
  dplyr::filter(!str_detect(ADM_CD, exclude_pattern))

print(paste("필터링 후 데이터 개수:", nrow(gdf_filtered)))

# 3. 코드 변경 및 병합 설정
gdf_processed <- gdf_filtered %>%
  mutate(
    # 변경될 최종 코드 (GROUP_CD) 정의
    GROUP_CD = case_when(
      # [변경 요청] 금수면: 37580350 -> 37580351
      ADM_CD == "37580350" ~ "37580351",
      
      # [병합] 율곡동 통합: 농소면(37030310) -> 율곡동(37030620)
      ADM_CD == "37030310" ~ "37030620",
      
      # [병합] 강남동 통합: 서구동(37040620) -> 강남동(37040630)
      ADM_CD == "37040620" ~ "37040630",
      
      # [병합] 서부1동 통합: 서부2동(37100570) -> 서부1동(37100530)
      ADM_CD == "37100570" ~ "37100530",
      
      # 나머지는 원래 코드 유지
      TRUE ~ ADM_CD
    ),
    
    # 변경될 최종 이름 (GROUP_NM) 정의
    GROUP_NM = case_when(
      ADM_CD == "37580350" ~ "금수면", # 이름은 유지하거나 필요시 변경
      ADM_CD == "37030310" ~ "율곡동",
      ADM_CD == "37040620" ~ "강남동",
      ADM_CD == "37100570" ~ "서부1동",
      TRUE ~ ADM_NM
    )
  )

# 4. 지오메트리 병합 (Dissolve)
# 같은 코드를 가진 행들을 하나로 합침
gdf_merged <- gdf_processed %>%
  group_by(GROUP_CD, GROUP_NM) %>%
  summarise(geometry = st_union(geometry), .groups = "drop") %>%
  rename(ADM_CD = GROUP_CD, ADM_NM = GROUP_NM)

print(paste("병합 후 데이터 개수:", nrow(gdf_merged)))

# 5. 결과 저장
output_path <- "filtered_merged_data.gpkg"
st_write(gdf_merged, output_path, delete_dsn = TRUE)

print("작업 완료: filtered_merged_data.gpkg 파일이 갱신되었습니다.")
```

```{r}
# 1. 파일 경로 설정 (CSV 파일명은 실제 이름으로 변경해주세요)
gpkg_path <- "filtered_merged_data.gpkg"
csv_path  <- "data/emd_2024_merged_final.csv"  # <-- 실제 CSV 파일 경로로 수정 필요

# 2. GPKG 파일 불러오기
gdf <- st_read(gpkg_path, quiet = TRUE)

# 3. CSV 파일 불러오기
# (한글이 포함된 CSV라면 locale 설정이 필요할 수 있습니다. 예: locale=locale(encoding="EUC-KR"))
df_csv <- read_csv(csv_path, show_col_types = FALSE) 

# 만약 CSV의 ADM_CD가 숫자로 되어 있다면 문자로 변환 (Join을 위해 타입 일치)
df_csv <- df_csv %>%
  mutate(ADM_CD = as.character(ADM_CD))

# 4. 데이터 결합 (Left Join: 지도 데이터 기준)
# 공간 데이터(gdf)를 왼쪽에 두어야 공간 속성(geometry)이 유지됩니다.
gdf_joined <- gdf %>%
  left_join(df_csv, by = "ADM_CD")

# 5. 결과 확인
print("### 결합된 데이터 확인 ###")
print(head(gdf_joined))

# 6. (선택) 결합된 데이터 저장
# st_write(gdf_joined, "final_joined_data.gpkg", delete_dsn = TRUE)
```
### mapping
```{r}
library(ggplot2)
library(sf)

# 1. 데이터 전처리 (중요)
# Y2024 컬럼이 문자(Character)로 되어있거나 콤마(,)가 포함되어 있을 수 있으므로 숫자로 변환합니다.
gdf_joined$Y2024 <- as.numeric(gsub(",", "", as.character(gdf_joined$Y2024)))

# 2. 단계구분도 그리기
ggplot(data = gdf_joined) +
  # (1) 지오메트리 설정: fill에 Y2024 변수를 매핑
  geom_sf(aes(fill = Y2024), color = "white", lwd = 0.1) + 
  
  # (2) 색상 테마 설정 (옵션)
  # - scale_fill_viridis_c: 시인성이 좋은 색상표 (option="plasma", "magma", "viridis" 등)
  # - labels = scales::comma : 범례 숫자에 콤마 추가
  scale_fill_viridis_c(option = "plasma", name = "2024 수치", labels = scales::comma) +
  
  # (3) 디자인 다듬기
  theme_void() + # 배경의 위경도 숫자와 그리드 제거 (깔끔하게)
  labs(
    title = "2024년 행정동별 총인구",
    subtitle = "경상북도(영양/청송/울릉 제외) + 충청북도 영동군 + 대구광역시 군위군",
    caption = "Data Source: 행정안전부,「주민등록인구현황」"
  ) +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, face = "bold", size = 15)
  )
```

